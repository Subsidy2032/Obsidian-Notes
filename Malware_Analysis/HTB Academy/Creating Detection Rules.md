Having now uncovered the Tactics, Techniques, and Procedures (TTPs) employed by this malware, we can proceed to design detection rules, such as `Yara` and `Sigma` rules.

## Yara

YARA (Yet Another Recursive Acronym), a widely used open-source pattern matching tool and rule-based malware detection and classification framework let us use custom rules to spot specific patterns or characteristics in files, processes, or memory. To draft a YARA rule for our sample, we'll need to examine the behavior, features, or specific strings/patterns unique to the sample we aim to detect.

Here's a simple example of a `YARA` rule that matches the presence of the string `Sandbox detected` in a process. We remind you that `shell.exe` demonstrated such behavior.
```yara
rule Shell_Sandbox_Detection {
    strings:
        $sandbox_string = "Sandbox detected"
    condition:
        $sandbox_string
}
```

Now let's add a lot more strings and patterns into the rule to make it better.

We can utilized the yarGen tool, which automates the process of generating YARA rules, with the prime objective of crafting the best possible rules for manual post-processing. This, however, necessitates a shrewd automatic preselection and a discerning human analyst to generate a robust rule.

First let's create a new directory called `Test` inside the `/home/htb-student/Samples/MalwareAnalysis` directory of this section's target and then let's copy `shell.exe` (residing in the `/home/htb-student/Samples/MalwareAnalysis` directory) to the newly created `Test` directory as follows.
```shell-session
$ mkdir /home/htb-student/Samples/MalwareAnalysis/Test
```

```shell-session
$ cp /home/htb-student/Samples/MalwareAnalysis/shell.exe /home/htb-student/Samples/MalwareAnalysis/Test/
```

To automatically create a Yara rule for `shell.exe` we should execute the following (inside the `/home/htb-student/yarGen-0.23.4` directory).
```shell-session
$ sudo python3 yarGen.py -m /home/htb-student/Samples/MalwareAnalysis/Test/
------------------------------------------------------------------------
                   _____            
    __ _____ _____/ ___/__ ___      
   / // / _ `/ __/ (_ / -_) _ \     
   \_, /\_,_/_/  \___/\__/_//_/     
  /___/  Yara Rule Generator        
         Florian Roth, July 2020, Version 0.23.3
   
  Note: Rules have to be post-processed
  See this post for details: https://medium.com/@cyb3rops/121d29322282
------------------------------------------------------------------------
[+] Using identifier 'Test'
[+] Using reference 'https://github.com/Neo23x0/yarGen'
[+] Using prefix 'Test'
[+] Processing PEStudio strings ...
[+] Reading goodware strings from database 'good-strings.db' ...
    (This could take some time and uses several Gigabytes of RAM depending on your db size)
[+] Loading ./dbs/good-imphashes-part3.db ...
[+] Total: 4029 / Added 4029 entries
[+] Loading ./dbs/good-strings-part9.db ...
[+] Total: 788 / Added 788 entries
[+] Loading ./dbs/good-strings-part8.db ...
[+] Total: 332082 / Added 331294 entries
[+] Loading ./dbs/good-imphashes-part4.db ...
[+] Total: 6426 / Added 2397 entries
[+] Loading ./dbs/good-strings-part2.db ...
[+] Total: 1703601 / Added 1371519 entries

<SNIP>

[+] Loading ./dbs/good-exports-part5.db ...
[+] Total: 404321 / Added 71962 entries
[+] Processing malware files ...
[+] Processing /home/htb-student/Samples/MalwareAnalysis/Test/shell.exe ...
[+] Generating statistical data ...
[+] Generating Super Rules ... (a lot of magic)
[+] Generating Simple Rules ...
[-] Applying intelligent filters to string findings ...
[-] Filtering string set for /home/htb-student/Samples/MalwareAnalysis/Test/shell.exe ...
[=] Generated 1 SIMPLE rules.
[=] All rules written to yargen_rules.yar
[+] yarGen run finished
```

We will notice that a file named `yargen_rule.yar` is generated by `yarGen` that incorporates unique strings, which are automatically extracted and inserted into the rule.
```shell-session
$ cat yargen_rules.yar 
/*
   YARA Rule Set
   Author: yarGen Rule Generator
   Date: 2023-08-02
   Identifier: Test
   Reference: https://github.com/Neo23x0/yarGen
*/

/* Rule Set ----------------------------------------------------------------- */

rule _home_htb_student_Samples_MalwareAnalysis_Test_shell {
   meta:
      description = "Test - file shell.exe"
      author = "yarGen Rule Generator"
      reference = "https://github.com/Neo23x0/yarGen"
      date = "2023-08-02"
      hash1 = "bd841e796feed0088ae670284ab991f212cf709f2391310a85443b2ed1312bda"
   strings:
      $x1 = "C:\\Windows\\System32\\cmd.exe" fullword ascii
      $s2 = "http://ms-windows-update.com/svchost.exe" fullword ascii
      $s3 = "C:\\Windows\\System32\\notepad.exe" fullword ascii
      $s4 = "/k ping 127.0.0.1 -n 5" fullword ascii
      $s5 = "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" fullword ascii
      $s6 = "  VirtualQuery failed for %d bytes at address %p" fullword ascii
      $s7 = "[-] Error code is : %lu" fullword ascii
      $s8 = "C:\\Program Files\\VMware\\VMware Tools\\" fullword ascii
      $s9 = "Failed to open the registry key." fullword ascii
      $s10 = "  VirtualProtect failed with code 0x%x" fullword ascii
      $s11 = "Connection sent to C2" fullword ascii
      $s12 = "VPAPAPAPI" fullword ascii
      $s13 = "AWAVAUATVSH" fullword ascii
      $s14 = "45.33.32.156" fullword ascii
      $s15 = "  Unknown pseudo relocation protocol version %d." fullword ascii
      $s16 = "AQAPRQVH1" fullword ascii
      $s17 = "connect" fullword ascii /* Goodware String - occured 429 times */
      $s18 = "socket" fullword ascii /* Goodware String - occured 452 times */
      $s19 = "tSIcK<L" fullword ascii
      $s20 = "Windows-Update/7.6.7600.256 %s" fullword ascii
   condition:
      uint16(0) == 0x5a4d and filesize < 60KB and
      1 of ($x*) and 4 of them
}
```

We can review the rule and modify it as necessary, adding more strings and conditions to enhance its reliability and effectiveness.

## Detecting Malware Using Yara Rules

We can then use this rule to scan a directory as follows.
```shell-session
$ yara /home/htb-student/yarGen-0.23.4/yargen_rules.yar /home/htb-student/Samples/MalwareAnalysis/
home_htb_student_Samples_MalwareAnalysis_Test_shell /home/htb-student/Samples/MalwareAnalysis//shell.exe
```

We will notice that `shell.exe` is returned!

**Below are some references for YARA rules**:

- Yara documentation : [https://yara.readthedocs.io/en/stable/writingrules.html](https://yara.readthedocs.io/en/stable/writingrules.html)
- Yara resources - [https://github.com/InQuest/awesome-yara](https://github.com/InQuest/awesome-yara)
- The DFIR Report - [https://github.com/The-DFIR-Report/Yara-Rules](https://github.com/The-DFIR-Report/Yara-Rules)

## Sigma

Sigma is a comprehensive and standardized rule format extensively used by security analysts and Security Information and Event Management (SIEM) systems. The objective is to detect and identify specific patterns or behaviors that could potentially signify security threats or events. The standardized format of Sigma rules enables security team to define and disseminate detection logic across diverse security platforms.

To construct a Sigma rule based on certain actions, for instance, dropping a file in a temporary location, we can devise a sample rule along those lines.
```sigma
title: Suspicious File Drop in Users Temp Location
status: experimental
description: Detects suspicious activity where a file is dropped in the temp location

logsource:
    category: process_creation
detection:
    selection:
        TargetFilename:
            - '*\\AppData\\Local\\Temp\\svchost.exe'
    condition: selection
    level: high

falsepositives:
    - Legitimate exe file drops in temp location
```

In this instance, the rule is designed to identify when the file `svchost.exe` is dropped in the `Temp` directory.

During analysis, it's advantageous to have a system monitoring agent operating continuously. In this context, we've chosen `Sysmon` to gather the logs. `Sysmon` is a powerful tool that captures detailed event data and aids in the creation of `Sigma` rules. Its log categories encompass process creation (`EventID 1`), network connection (`EventID 3`), file creation (`EventID 11`), registry modification (`EventID 13`), among others. The scrutiny of these events assists in pinpointing indicators of compromise (`IOC`s) and understanding behavior patterns, thus facilitating the crafting of effective detection rules.

For instance, `Sysmon` has collected logs such as `process creation`, `process access`, `file creation`, and `network connection`, among others, in response to the activities conducted by `shell.exe`. This compiled information proves instrumental in enhancing our understanding of the sample's behavior and developing more precise and effective detection rules.

**Process Create Logs**:
![[sysmon_01_process.webp]]

**Process Access Logs** (not configured in the Windows targets of this module):
![[sysmon_10_access.webp]]

**File Creation Logs**:
![[sysmon_11_file.webp]]

**Network Connection Logs**:
![[sysmon_03_network.webp]]

**Below are some references for Sigma rules**:

- Sigma documentation : [https://github.com/SigmaHQ/sigma/wiki/Specification](https://github.com/SigmaHQ/sigma/wiki/Specification)
- Sigma resources - [https://github.com/SigmaHQ/sigma/tree/master/rules](https://github.com/SigmaHQ/sigma/tree/master/rules)
- The DFIR Report - [https://github.com/The-DFIR-Report/Sigma-Rules/tree/main/rules](https://github.com/The-DFIR-Report/Sigma-Rules/tree/main/rules)
