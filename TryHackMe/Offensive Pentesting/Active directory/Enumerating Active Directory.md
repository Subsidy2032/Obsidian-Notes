#Windows #ActiveDirectory #Enumeration 
## Credential Injection

##### Windows vs Linux

You need to understand and mimic your enemy to be successful, that's why you will need a Windows machine to run built-in tools.

##### Runas Explained

Runas is the reason you might not be able to login with AD credentials, we can use Runas to inject credentials into the memory.

`runas.exe /netonly /user:<domain>\<username> cmd.exe` - Use Runas to launch CMD as a network user, `/netonly` is to authenticate trough the network and not the DC, commands will run in the context of your local system account while network connection will occur using the account specified, you can provide any password when asked.

You can run anything else other than cmd.

Note: Run the first command prompt as administrator, so the administrator token will get injected into the CMD and you'll be able to run tools as administrator using your Runas spawned CMD.

##### It's Always DNS

After that the most surefire way of verifying that your credentials are working is to list the SYSVOL directory, which can be read by any user.

SYSVOL is a shared folder existing in all DCs storing the Group Policy Object (GPOs) and information along with any domain related scripts, this way domain-joined computers apply the applicable configuration.

Before listing SYSVOL you should configure DNS manually (if not configured by DHCP or the VPN connection), execute the following commands in Powershell:

1. `$dnsip = "<DC IP>"`
2. `$index = Get-NetAdapter -Name '<interface name (usually Ethernet)>' | Select-Object -ExpandProperty 'ifIndex'`
3. `Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip`

`nslookup <domain name>` - Verify that DNS is working.

Now you can test your credentials, and enumerate the contents which might have additional credentials:

`dir \\<domain name>\SYSVOL` - Force a network-based listing of the SYSVOL directory.

##### IP vs Hostnames

The difference between `dir \\<hostname>\SYSVOL` and `dir \\<DC IP>\SYSVOL`:

When we provide hostname network authentication will attempt first to perform Kerberos, since Kerberos uses hostnames embedded in the tickets, with providing the IP you can force NTLM authentication which can be stealthier if the organization is monitoring attacks like pass-the-hash.

##### Using Injected Credentials

Now for example if an MS SQL database uses windows authentication and you are not domain joined, you can start MS SQL Studio from the CMD and even though you will log in as local user, it will use the AD credentials in the background to authenticate.
## Enumeration through Microsoft Management Console

##### Microsoft Management Console

We will use the Microsoft Management Console (MMC) and Remote Server Administration Tools (RSAT) Snap-Ins.
Steps to install:

1. Press **Start**
2. Search **"Apps & Features"** and press enter
3. Click **Manage Optional Features**
4. Click **Add a feature**
5. Search for **"RSAT"**
6. Select "**RSAT: Active Directory Domain Services and Lightweight Directory Tools"** and click **Install**

You can run MMC trough Windows Start button or trough run, but it wouldn't work with our local account that can't authenticate to the domain.

So we use the Runas window to ensure all MMC network connections will use the injected AD credentials.

In MMC attach AD RSAT snap-in:

1. Click **File** -> **Add/Remove Snap-in**
2. Select and **Add** all three Active Directory Snap-ins
3. Click through any errors and warnings
4. Right-click on **Active Directory Domains and Trusts** and select **Change Forest**
5. Enter the hostname as the **Root domain** and Click **OK**
6. Right-click on **Active Directory Sites and Services** and select **Change Forest**
7. Enter the hostname as the **Root domain** and Click OK
8. Right-click on **Active Directory Users and Computers** and select **Change Domain**
9. Enter hostname as the **Domain** and Click **OK**
10. Right-click on **Active Directory Users and Computers** in the left-hand pane
11. Click on **View** -> **Advanced Features**

Your MMC should now be pointed to and authenticated against the target domain.

##### Users and computers

Expand the Users and Computers snap-in and the domain to see the initial Organizational Unit (OU) structure, clicking on each OU will so users that belong there.

We can retrieve the properties and attributes and also see the groups the users belong to by clicking on them, by clicking on Servers or Workstations we can see domain-joined machines.

With the relevant permissions we can make changes to the AD trough the MMC as well.

##### Benefits

- Holistic view with the GUI.
- Rapid searching of AD objects.
- Direct method to view specific updates of AD objects.
- We can add or update new object if we have sufficient privileges.

##### Drawbacks

- Requires RDP access.
- Can't gather AD wide properties or attributes.

## Enumeration through Command Prompt
##### Users

`net user /domain` - List all users in the AD Domain.

`net user <username> /domain` - Enumerate more details for a specific user account, the command will fail to list all group memberships if there are like more than 10.

##### Groups

`net group /domain` - Enumerate domain groups.

`net group "<group>" /domain` - Enumerate more details for a specific group such as memberships to the group.

##### Password Policy

`net accounts /domain` - Enumerate the password policy.

##### Benefits

- No additional or external tooling is required, and the `net` command usually isn't monitored by the blue team.
- No need for GUI
- VBScript and other macro languages that are used for phishing support those command, which can help with initial enumeration.

##### Drawbacks

- Must be executed from a domain joined machine.
- The `net` command my not show all information.

## Enumeration trough Powershell

##### Powershell

In addition to all CMD functions, Powershell provides access to cmdlets (command-lets) which are .NET classes to perform specific functions, we can write our own or use built in ones.

the AD-RAST tooling we installed automatically installed the associated cmdlets for us.

`powershell` - Upgrade to Powershell trough SSH connection.

##### Users

`Get-ADUser -Identify <username> -Server <hostname> -Properties *` - Enumerate AD users, the `-server` option is because we are not domain joined and `-properties` tells the command which account properties we want to enumerate.

`Get-ADUser -Filter 'Name -like "*stevens"' -Server za.tryhackme.com | Format-Table Name,SamAccountName -A` - Filter by pattern and display in a table format.

##### Groups

`Get-ADGroup -Identity <group name> -Server hostname` - Enumerate AD groups.

`Get-ADGroupMember -Identity <group name> -Server <hostname>` - Enumerate group membership.

##### AD Objects

`Get-ADObject` can be used for a more generic search of AD Objects.

`$ChangeDate = New-Object DateTime(<year>, <month>, <day>, <hour>, <minute>, <second>)` - Create a date variable.
`Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server za.tryhackme.com` - Look for AD Objects that were changed after a specific date.

`Get-ADObject -Filter 'badPwdCount -gt 0' -Server za.tryhackme.com` - Enumerate for accounts with badPwdCount higher than 0, to avoid them in a password spraying attack.

##### Domains

`Get-ADDomain -Server <domain>` - Retrieve additional information about the specific domain.

##### Altering AD Objects

With some AD-RSAT cmdlets you can create or alter AD objects.

`Set-ADAccountPassword -Identity <username> -Server <domain name> -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "<new password>" -Force)` - Change the password for an AD user.

##### Benefits

- Can enumerate more information than the CMD.
- We can specify the server and domain using runas from a non domain joined machines.
- We can create our own cmdlets.
- We can make changes with AD-RSAT cmdlets.

##### Drawbacks

- Powershell is more often monitored by the blue team.
- We have to install AD-RSAT or other potentially detectable scripts.

## Enumeration trough Bloodhound

##### Bloodhound History

Microsoft integrated their own version of Bloodhound in its Advanced Threat Protection solution.

Attackers use Bloodhound to visualize the AD environment in graph format with interconnected nodes, while defenders used lists.

It allowed a two-stage attack in which first the attacker will make a phishing campaign which is detectable and will only help with enumeration, than by using Bloodhound planning all the steps and hops required for an attack which can take only minutes once the domain is compromised, because of this power blue teams started using this tool as well.

##### Sharphound

Sharphound is the tool to enumerate the AD, while Bloodhound is the GUI tool to display it, Bloodhound and Sharphound should match for best results.

- **Sharphound.ps1**: Powershell script for running Sharphound, the latest release has stopped releasing it, good to use with RATs since the script can be loaded directly to the memory and not be detected by on-disk AV scans.
- **Sharphound.exe**: A Windows executable version.
- **AzureHound.ps1**: Script for running Bloodhound for Azura, Bloodhound can ingest data enumerated from Azura to find attack paths related to the configuration of Azure Identity and Access Management.

We can use the scripts trough a local machine using the `runas` to avoid detection, since our control over the machine lets us disable the AV or make exceptions for specific files or folders.

`Sharphound.exe --CollectionMethods <Methods> --Domain <hostname> --ExcludeDCs` - Collect data with Sharphound.

- `CollectionMethods`: Determines what kind of data to collect (most commonly Default or ALL), because it caches information after the first run you can only use the session collection method to retrieve new user sessions to speed up the process.
- `Domain`: You can also specify a parent or another domain.
- `ExcludeDCs`: Don't touch DCs, reduces the chances of an alert.

##### Bloodhound

Bloodhound uses Neo4j (a graph database management system) as its backend database and graphing system, it will visualize the zip file we generated with Sharphound into attack paths.

`neo4j console start` - Load neo4j.

`bloodhound --no-snadbox` - In another terminal open the Bloodhound's authentication GUI, the default neo4j database are `neo4j:neo4j`.

`scp <AD username>@<domain name>:<zip file location> <Local directory path>` - Copy the zip file to your machine.

Now import the file into Bloodhound by dragging and dropping.

##### Attack Paths

Press the 3 strips next to "Search for a node" to see option, the first tab will provide information on current imports, counts will increase with each new Sharphound file loaded.

In Node Info you should click on a node to refresh the view, you can change the label scheme by pressing LeftCtrl.

There are the following categories in Node Info:

- **Overview** - Provides summaries information such as the number of active sessions the account has and if it can reach high-value targets.
- **Node Properties** - Shows information regarding the AD account, such as the display name and the title.
- **Extra Properties** - Provides more detailed AD information such as the distinguished name and when the account was created.  
- **Group Membership** - Shows information regarding the groups that the account is a member of.
- **Local Admin Rights** - Provides information on domain-joined hosts where the account has administrative privileges.
- **Execution Rights** - Provides information on special privileges such as the ability to RDP into a machine.
- **Outbound Control Rights** - Shows information regarding AD objects where this account has permissions to modify their attributes.
- **Inbound Control Rights** -  Provides information regarding AD objects that can modify the attributes of this account.

To see more information on each of the categories press on the number next to the information query.

The Analysis queries is queries the creators of Bloodhound wrote themselve, we can run the Find all Domain Admins query from Domain Information.

Icons are called nodes and the lines called edges, a user in a group that is nested to the the Domain Admins group is DA.

With Edge Filtering you can select a start node for which you have access to and an end node which you want to gain access to.

##### Session Data Only

Since users are always logging on and off we will want to execute Sharphound at regular intervals, to have to most updated results.

It's a good idea to start with the "All" collection method and than run Sharphound at list twice a day with the Session collection method, best at 10:00 when users start to work and 14:00 when they are back from their lunch.

In Bloodhound go to the Database Info tab, than click "Clear Session Information" before importing the new Sharphound runs.

##### Benefits

- Provides GUI.
- Attack paths.
- More profound insight into AD Objects without manual queries.

##### Drawbacks

- Requires the execution of Sharphound, which can be often noisy.

## conclusion

##### Additional Enumeration Techniques

- [LDAP Enumeration](https://book.hacktricks.xyz/pentesting/pentesting-ldap): With valid AD credentials you can bind to a DC's LDAP interface, those you can write LDAP search queries.
- [PowerView](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1): A recon script of the PowerSploit project, doesn't longer receive support but there are other similar tools.
- [Windows Management Instrumentation (WMI)](https://0xinfection.github.io/posts/wmi-ad-enum/): You can use the provider "root\directory\ldap" that WMI has with WMI in Powershell to enumerate information from windows hosts.

##### Mitigations

- Enumeration tools like Sharphound will generate a lot of log-on events from a single account, we can write detection rules for this.
- We can write signature detection rules for enumeration tools.
- If not used by employees, we can enumerate the CMD and PS.

The blue team can also use the enumeration methods themselves to close gaps.